<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½• - Otherwise</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: var(--color-background-secondary);">
    <div style="width: 100%; max-width: 400px; padding: 0 var(--spacing-lg);">
        <!-- Logo and Title -->
        <div class="text-center" style="margin-bottom: 3rem;">
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Otherwise</h1>
            <p style="color: var(--color-text-secondary); font-size: 0.875rem;">å¦åˆ™</p>
        </div>

        <!-- Login Form -->
        <div class="card" style="padding: 2.5rem;">
            <div class="text-center" style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">æ¬¢è¿å›æ¥</h2>
                <p style="color: var(--color-text-secondary); font-size: 0.875rem;">
                    è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ
                    <a href="register.html" style="color: var(--color-text-primary); font-weight: 500;">ç«‹å³æ³¨å†Œ</a>
                </p>
            </div>

            <form id="loginForm" novalidate>
                <!-- ç”¨æˆ·åæˆ–é‚®ç®±è¾“å…¥ -->
                <div class="form-group">
                    <label for="loginIdentifier" class="form-label">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                    <input id="loginIdentifier" name="loginIdentifier" type="text" required 
                           class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±">
                    <p class="message-error" id="loginIdentifierError" style="display: none; margin-top: 0.5rem; font-size: 0.75rem;"></p>
                </div>

                <!-- å¯†ç è¾“å…¥ -->
                <div class="form-group">
                    <label for="password" class="form-label">å¯†ç </label>
                    <div style="position: relative;">
                        <input id="password" name="password" type="password" required 
                               class="form-input" placeholder="è¯·è¾“å…¥å¯†ç " style="padding-right: 3rem;">
                        <button type="button" id="togglePassword" 
                                style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--color-text-muted); cursor: pointer;">
                            ğŸ‘ï¸
                        </button>
                    </div>
                    <p class="message-error" id="passwordError" style="display: none; margin-top: 0.5rem; font-size: 0.75rem;"></p>
                </div>

                <!-- è®°ä½æˆ‘ -->
                <div style="margin-bottom: 2rem;">
                    <label class="flex items-center" style="cursor: pointer;">
                        <input id="rememberMe" name="rememberMe" type="checkbox" 
                               style="margin-right: 0.5rem; accent-color: var(--color-primary);">
                        <span style="font-size: 0.875rem;">è®°ä½æˆ‘</span>
                    </label>
                </div>

                <!-- ç™»å½•æŒ‰é’® -->
                <button type="submit" id="submitButton" class="btn btn-primary" 
                        style="width: 100%; margin-bottom: 1.5rem;">
                    <span id="submitText">ç™»å½•</span>
                    <span id="submitLoading" style="display: none;">ç™»å½•ä¸­...</span>
                </button>

                <!-- æ¶ˆæ¯æç¤ºåŒºåŸŸ -->
                <div id="loginErrorAlert" class="message message-error" style="display: none;">
                    <p id="loginErrorMessage" style="margin: 0;"></p>
                </div>

                <div id="loginSuccessAlert" class="message message-success" style="display: none;">
                    <p id="loginSuccessMessage" style="margin: 0;">ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...</p>
                </div>
            </form>

            <!-- åº•éƒ¨é“¾æ¥ -->
            <div style="margin-top: 2rem; display: flex; gap: 0.75rem;">
                <a href="register.html" class="btn btn-secondary" style="flex: 1; text-align: center;">æ³¨å†Œæ–°è´¦æˆ·</a>
                <a href="index.html" class="btn btn-ghost" style="flex: 1; text-align: center;">è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </div>

    <!-- åŠ è½½main.js -->
    <script src="main.js?v=20241219"></script>

    <script>
        // ç®€åŒ–çš„ç™»å½•ç®¡ç†å™¨
        class SimpleLoginManager {
            constructor() {
                this.isLoading = false;
                this.init();
            }

            init() {
                this.bindEvents();
                this.initPasswordToggle();
                this.checkRememberMe();
            }

            bindEvents() {
                const form = document.getElementById('loginForm');
                form.addEventListener('submit', this.handleSubmit.bind(this));
            }

            initPasswordToggle() {
                const toggleButton = document.getElementById('togglePassword');
                const passwordField = document.getElementById('password');
                
                toggleButton.addEventListener('click', () => {
                    const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordField.setAttribute('type', type);
                    toggleButton.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
                });
            }

            checkRememberMe() {
                const remembered = localStorage.getItem('rememberedUser');
                if (remembered) {
                    try {
                        const userData = JSON.parse(remembered);
                        document.getElementById('loginIdentifier').value = userData.identifier;
                        document.getElementById('rememberMe').checked = true;
                    } catch (e) {
                        console.error('è§£æè®°ä½çš„ç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                    }
                }
            }

            showFieldError(fieldId, message) {
                const errorElement = document.getElementById(fieldId + 'Error');
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
                
                const inputElement = document.getElementById(fieldId);
                if (inputElement) {
                    inputElement.style.borderColor = '#ef4444';
                }
            }

            clearFieldError(fieldId) {
                const errorElement = document.getElementById(fieldId + 'Error');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                
                const inputElement = document.getElementById(fieldId);
                if (inputElement) {
                    inputElement.style.borderColor = '';
                }
            }

            showLoginError(message) {
                const errorAlert = document.getElementById('loginErrorAlert');
                const errorMessage = document.getElementById('loginErrorMessage');
                const successAlert = document.getElementById('loginSuccessAlert');
                
                if (errorMessage) errorMessage.textContent = message;
                if (errorAlert) errorAlert.style.display = 'block';
                if (successAlert) successAlert.style.display = 'none';
            }

            showLoginSuccess(message) {
                const errorAlert = document.getElementById('loginErrorAlert');
                const successAlert = document.getElementById('loginSuccessAlert');
                const successMessage = document.getElementById('loginSuccessMessage');
                
                if (successMessage) successMessage.textContent = message;
                if (successAlert) successAlert.style.display = 'block';
                if (errorAlert) errorAlert.style.display = 'none';
            }

            hideAllMessages() {
                const errorAlert = document.getElementById('loginErrorAlert');
                const successAlert = document.getElementById('loginSuccessAlert');
                
                if (errorAlert) errorAlert.style.display = 'none';
                if (successAlert) successAlert.style.display = 'none';
            }

            setLoadingState(loading) {
                this.isLoading = loading;
                const submitButton = document.getElementById('submitButton');
                const submitText = document.getElementById('submitText');
                const submitLoading = document.getElementById('submitLoading');
                
                if (loading) {
                    submitButton.disabled = true;
                    if (submitText) submitText.style.display = 'none';
                    if (submitLoading) submitLoading.style.display = 'inline-block';
                } else {
                    submitButton.disabled = false;
                    if (submitText) submitText.style.display = 'inline-block';
                    if (submitLoading) submitLoading.style.display = 'none';
                }
            }

            validateForm() {
                let isValid = true;
                
                const identifier = document.getElementById('loginIdentifier').value.trim();
                const password = document.getElementById('password').value.trim();
                
                this.clearFieldError('loginIdentifier');
                this.clearFieldError('password');
                
                if (!identifier) {
                    this.showFieldError('loginIdentifier', 'è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±');
                    isValid = false;
                }
                
                if (!password) {
                    this.showFieldError('password', 'è¯·è¾“å…¥å¯†ç ');
                    isValid = false;
                }
                
                return isValid;
            }

            getAllUsers() {
                const users = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('user_')) {
                        try {
                            const userData = JSON.parse(localStorage.getItem(key));
                            users.push(userData);
                        } catch (e) {
                            console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', key, e);
                        }
                    }
                }
                return users;
            }

            async performLogin(loginData) {
                // æ¨¡æ‹Ÿ API è¯·æ±‚å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 800));

                const users = this.getAllUsers();
                console.log('æŸ¥æ‰¾ç”¨æˆ·ä¸­...', { 
                    identifier: loginData.identifier, 
                    userCount: users.length 
                });

                const user = users.find(u => {
                    const usernameMatch = u.username === loginData.identifier;
                    const emailMatch = u.email === loginData.identifier;
                    const passwordMatch = u.password === loginData.password;
                    
                    return (usernameMatch || emailMatch) && passwordMatch;
                });

                if (user) {
                    console.log('ç™»å½•æˆåŠŸ:', user.username);
                    return {
                        success: true,
                        user: {
                            id: user.id,
                            username: user.username,
                            email: user.email,
                            userType: user.userType,
                            organization: user.organization,
                            researchField: user.researchField
                        }
                    };
                } else {
                    console.log('ç™»å½•å¤±è´¥: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                    return {
                        success: false,
                        message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
                    };
                }
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                if (this.isLoading) return;
                
                if (!this.validateForm()) {
                    return;
                }

                this.setLoadingState(true);
                this.hideAllMessages();

                try {
                    const loginData = {
                        identifier: document.getElementById('loginIdentifier').value.trim(),
                        password: document.getElementById('password').value.trim(),
                        rememberMe: document.getElementById('rememberMe').checked
                    };

                    const result = await this.performLogin(loginData);
                    
                    if (result.success) {
                        // ä¿å­˜ç™»å½•çŠ¶æ€
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('username', result.user.username);
                        localStorage.setItem('currentUser', JSON.stringify(result.user));
                        
                        // ä¿å­˜è®°ä½æˆ‘é€‰é¡¹
                        if (loginData.rememberMe) {
                            localStorage.setItem('rememberedUser', JSON.stringify({
                                identifier: loginData.identifier
                            }));
                        } else {
                            localStorage.removeItem('rememberedUser');
                        }
                        
                        // æ›´æ–°å…¨å±€ç”¨æˆ·çŠ¶æ€
                        if (window.otherwiseApp) {
                            window.otherwiseApp.currentUser = {
                                ...result.user,
                                isLoggedIn: true
                            };
                            console.log('æ›´æ–°å…¨å±€ç”¨æˆ·çŠ¶æ€æˆåŠŸ');
                        }
                        
                        this.showLoginSuccess(`æ¬¢è¿å›æ¥ï¼Œ${result.user.username}ï¼`);
                        
                        // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                        setTimeout(() => {
                            const urlParams = new URLSearchParams(window.location.search);
                            const redirect = urlParams.get('redirect') || 'profile.html';
                            console.log('è·³è½¬åˆ°:', redirect);
                            window.location.href = redirect;
                        }, 1500);
                        
                    } else {
                        this.showLoginError(result.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
                    }
                    
                } catch (error) {
                    console.error('ç™»å½•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                    this.showLoginError('ç™»å½•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
                } finally {
                    this.setLoadingState(false);
                }
            }
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç­‰å¾…main.jsåŠ è½½å®Œæˆååˆå§‹åŒ–ç™»å½•ç®¡ç†å™¨
            setTimeout(() => {
                console.log('åˆå§‹åŒ–ç™»å½•ç®¡ç†å™¨');
                window.loginManager = new SimpleLoginManager();
            }, 100);
        });
    </script>
</body>
</html> 