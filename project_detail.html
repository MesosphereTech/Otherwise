<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目详情 - Otherwise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Otherwise</h1>
                    <span class="ml-2 text-sm text-gray-500">否则</span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="index.html" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium">首页</a>
                        <a href="projects.html" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium">项目管理</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4" id="navButtons">
                    <!-- Content here will be dynamically inserted by navigation.js -->
                </div>
            </div>
        </nav>
    </header>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumb -->
        <div id="breadcrumb" class="text-sm text-gray-500 mb-4">
            <a href="index.html" class="hover:text-gray-900">首页</a> / 
            <a href="projects.html" class="hover:text-gray-900">项目管理</a> / 
            <span class="text-gray-500">项目详情</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2">
                <!-- Project Header -->
                <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h1 class="text-3xl font-bold text-gray-900 mb-2" id="projectTitle">加载中...</h1>
                            <div class="flex items-center space-x-4 text-sm text-gray-500" id="projectMeta">
                                <!-- Meta info will be populated by JS -->
                            </div>
                        </div>
                        <span class="px-4 py-2 rounded-full text-sm font-medium" id="projectStatus">
                            <!-- Status will be populated by JS -->
                        </span>
                    </div>
                    
                    <!-- Tags -->
                    <div class="flex flex-wrap gap-2 mb-4" id="projectTags">
                        <!-- Tags will be populated by JS -->
                    </div>
                </div>

                <!-- Project Description -->
                <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">项目描述</h2>
                    <div class="prose max-w-none text-gray-700" id="projectDescription">
                        <!-- Description will be populated by JS -->
                    </div>
                </div>

                <!-- Project Details -->
                <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">项目详情</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="projectDetails">
                        <!-- Details will be populated by JS -->
                    </div>
                </div>

                <!-- Expected Results -->
                <div class="bg-white rounded-lg shadow-sm p-8 mb-6" id="expectedResultsSection">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">预期成果</h2>
                    <div class="text-gray-700" id="expectedResults">
                        <!-- Expected results will be populated by JS -->
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="bg-white rounded-lg shadow-sm p-8 mb-6" id="contactSection">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">联系方式</h2>
                    <div class="text-gray-700" id="contactInfo">
                        <!-- Contact info will be populated by JS -->
                    </div>
                </div>

                <!-- Negation Discussion Integration -->
                <div class="bg-white rounded-lg shadow-sm p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-900">否定式讨论</h2>
                        <span class="text-sm text-gray-500">体现平台"否定驱动创新"理念</span>
                    </div>
                    
                    <!-- Discussion Preview -->
                    <div class="space-y-4" id="discussionPreview">
                        <!-- Discussion preview will be populated by JS -->
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <button onclick="viewFullDiscussion()" class="text-blue-600 hover:text-blue-800 font-medium">
                            查看完整讨论 →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <!-- Action Buttons -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">项目操作</h3>
                    <div class="space-y-3">
                        <!-- Interest Button -->
                        <button id="interestButton" onclick="expressInterest()" 
                                class="w-full bg-black text-white py-3 px-4 rounded-md hover:bg-gray-800 font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                            我感兴趣
                        </button>
                        
                        <!-- Follow Button -->
                        <button id="followButton" onclick="toggleFollow()" 
                                class="w-full bg-white text-gray-700 border border-gray-300 py-2 px-4 rounded-md hover:bg-gray-50 font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                            关注项目
                        </button>
                        
                        <!-- Share Button -->
                        <button onclick="shareProject()" 
                                class="w-full bg-white text-gray-700 border border-gray-300 py-2 px-4 rounded-md hover:bg-gray-50 font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                            分享项目
                        </button>
                    </div>
                </div>

                <!-- Project Stats -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">项目数据</h3>
                    <div class="space-y-3" id="projectStats">
                        <!-- Stats will be populated by JS -->
                    </div>
                </div>

                <!-- Publisher Info -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">发布者信息</h3>
                    <div id="publisherInfo">
                        <!-- Publisher info will be populated by JS -->
                    </div>
                </div>

                <!-- Related Projects -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">相关项目</h3>
                    <div class="space-y-4" id="relatedProjects">
                        <!-- Related projects will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interest Expression Modal -->
    <div id="interestModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">表达合作兴趣</h3>
                    <button onclick="closeInterestModal()" class="text-gray-400 hover:text-gray-600">✕</button>
                </div>
                <form id="interestForm" class="space-y-4">
                    <div>
                        <label for="cooperationRole" class="block text-sm font-medium text-gray-700">您的角色</label>
                        <select id="cooperationRole" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-black focus:border-black">
                            <option value="">请选择您的角色</option>
                            <option value="investor">投资方</option>
                            <option value="technical">技术合作伙伴</option>
                            <option value="industry">产业化伙伴</option>
                            <option value="researcher">研究合作者</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div>
                        <label for="cooperationMessage" class="block text-sm font-medium text-gray-700">合作意向说明</label>
                        <textarea id="cooperationMessage" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-black focus:border-black" 
                                  placeholder="请简要说明您的合作意向、资源优势等..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeInterestModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">取消</button>
                        <button type="submit" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800">提交申请</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="main.js"></script>
    <script src="navigation.js"></script>
    <script src="project_management.js"></script>

    <script>
        let currentProjectId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Get project ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('id');
            
            if (!currentProjectId) {
                window.otherwiseApp?.showMessage('项目ID不存在', 'error');
                setTimeout(() => { window.location.href = 'projects.html'; }, 1500);
                return;
            }

            loadProjectDetail(currentProjectId);
        });

        function loadProjectDetail(projectId) {
            // Load project data from localStorage or API
            const allProjects = JSON.parse(localStorage.getItem('mockProjects') || '[]');
            const project = allProjects.find(p => p.id === projectId);
            
            if (!project) {
                window.otherwiseApp?.showMessage('项目不存在', 'error');
                setTimeout(() => { window.location.href = 'projects.html'; }, 1500);
                return;
            }

            renderProjectDetail(project);
        }

        function renderProjectDetail(project) {
            // Render project title
            document.getElementById('projectTitle').textContent = project.title;
            
            // Render meta info
            const publishTime = window.utils?.formatTime(new Date(project.publishedAt)) || '未知时间';
            const metaHtml = `
                <span>发布者：${project.publisher}</span>
                <span>•</span>
                <span>发布时间：${publishTime}</span>
                <span>•</span>
                <span>所属行业：${project.industry}</span>
            `;
            document.getElementById('projectMeta').innerHTML = metaHtml;
            
            // Render status
            const statusElement = document.getElementById('projectStatus');
            const statusClass = project.status === 'recruiting' ? 'bg-green-100 text-green-800' : 
                               project.status === 'ongoing' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
            const statusText = project.status === 'recruiting' ? '招募中' : 
                              project.status === 'ongoing' ? '进行中' : '已结束';
            statusElement.className = `px-4 py-2 rounded-full text-sm font-medium ${statusClass}`;
            statusElement.textContent = statusText;
            
            // Render tags
            const tagsHtml = (project.technicalFields || []).map(field => 
                `<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">#${field}</span>`
            ).join('');
            document.getElementById('projectTags').innerHTML = tagsHtml;
            
            // Render description
            document.getElementById('projectDescription').innerHTML = project.description.replace(/\n/g, '<br>');
            
            // Render project details
            const detailsHtml = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">项目阶段</label>
                    <p class="text-gray-900">${getStageText(project.stage)}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">寻求合作类型</label>
                    <p class="text-gray-900">${project.cooperationType.join('、')}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">所需技术领域</label>
                    <p class="text-gray-900">${project.technicalFields.join('、')}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">招募截止时间</label>
                    <p class="text-gray-900">${window.utils?.formatTime(new Date(project.deadline)) || '长期有效'}</p>
                </div>
            `;
            document.getElementById('projectDetails').innerHTML = detailsHtml;
            
            // Render expected results if available
            if (project.expectedResults) {
                document.getElementById('expectedResults').innerHTML = project.expectedResults.replace(/\n/g, '<br>');
            } else {
                document.getElementById('expectedResultsSection').style.display = 'none';
            }
            
            // Render contact info if available
            if (project.contactInfo) {
                document.getElementById('contactInfo').innerHTML = project.contactInfo.replace(/\n/g, '<br>');
            } else {
                document.getElementById('contactSection').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500 mb-4">联系方式将在表达合作兴趣后显示</p>
                        <button onclick="expressInterest()" class="text-blue-600 hover:text-blue-800 font-medium">申请查看联系方式</button>
                    </div>
                `;
            }
            
            // Render stats
            const statsHtml = `
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">查看次数</span>
                    <span class="font-medium">${project.views || 0}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">感兴趣人数</span>
                    <span class="font-medium">${project.interestedCount || 0}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-600">关注人数</span>
                    <span class="font-medium">${project.followCount || 0}</span>
                </div>
            `;
            document.getElementById('projectStats').innerHTML = statsHtml;
            
            // Render publisher info
            const publisherHtml = `
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center">
                        <span class="text-gray-600 font-semibold">${project.publisher[0]}</span>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900">${project.publisher}</h4>
                        <p class="text-sm text-gray-500">${project.publisherType || '项目发布者'}</p>
                    </div>
                </div>
                <p class="text-sm text-gray-600">${project.publisherOrganization || '暂无机构信息'}</p>
            `;
            document.getElementById('publisherInfo').innerHTML = publisherHtml;
            
            // Update button states
            updateButtonStates(project);
        }

        function getStageText(stage) {
            const stageMap = {
                'concept': '概念验证阶段',
                'research': '实验室研发阶段',
                'prototype': '原型开发阶段',
                'testing': '测试验证阶段',
                'ready': '技术成熟，准备产业化',
                'scaling': '规模化生产阶段'
            };
            return stageMap[stage] || stage;
        }

        function updateButtonStates(project) {
            const currentUser = window.otherwiseApp?.currentUser;
            if (!currentUser?.isLoggedIn) return;
            
            // Update interest button if user already expressed interest
            const userInterests = JSON.parse(localStorage.getItem(`userInterests_${currentUser.id}`) || '[]');
            if (userInterests.includes(currentProjectId)) {
                const interestButton = document.getElementById('interestButton');
                interestButton.textContent = '已表达兴趣';
                interestButton.disabled = true;
                interestButton.className = 'w-full bg-gray-400 text-white py-3 px-4 rounded-md cursor-not-allowed font-medium';
            }
            
            // Update follow button if user is following
            const userFollows = JSON.parse(localStorage.getItem(`userFollows_${currentUser.id}`) || '[]');
            const followButton = document.getElementById('followButton');
            if (userFollows.includes(currentProjectId)) {
                followButton.textContent = '已关注';
                followButton.className = 'w-full bg-green-100 text-green-800 border border-green-300 py-2 px-4 rounded-md hover:bg-green-200 font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500';
            }
        }

        function expressInterest() {
            if (!window.otherwiseApp?.currentUser?.isLoggedIn) {
                window.otherwiseApp?.showMessage('请先登录', 'error');
                return;
            }
            
            document.getElementById('interestModal').classList.remove('hidden');
        }

        function closeInterestModal() {
            document.getElementById('interestModal').classList.add('hidden');
            document.getElementById('interestForm').reset();
        }

        function toggleFollow() {
            if (!window.otherwiseApp?.currentUser?.isLoggedIn) {
                window.otherwiseApp?.showMessage('请先登录', 'error');
                return;
            }
            
            const currentUser = window.otherwiseApp.currentUser;
            const userFollows = JSON.parse(localStorage.getItem(`userFollows_${currentUser.id}`) || '[]');
            const followButton = document.getElementById('followButton');
            
            if (userFollows.includes(currentProjectId)) {
                // Unfollow
                const index = userFollows.indexOf(currentProjectId);
                userFollows.splice(index, 1);
                localStorage.setItem(`userFollows_${currentUser.id}`, JSON.stringify(userFollows));
                
                followButton.textContent = '关注项目';
                followButton.className = 'w-full bg-white text-gray-700 border border-gray-300 py-2 px-4 rounded-md hover:bg-gray-50 font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black';
                window.otherwiseApp?.showMessage('取消关注成功', 'success');
            } else {
                // Follow
                userFollows.push(currentProjectId);
                localStorage.setItem(`userFollows_${currentUser.id}`, JSON.stringify(userFollows));
                
                followButton.textContent = '已关注';
                followButton.className = 'w-full bg-green-100 text-green-800 border border-green-300 py-2 px-4 rounded-md hover:bg-green-200 font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500';
                window.otherwiseApp?.showMessage('关注成功', 'success');
            }
        }

        function shareProject() {
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('projectTitle').textContent,
                    url: window.location.href
                });
            } else {
                // Fallback to copy URL
                navigator.clipboard.writeText(window.location.href).then(() => {
                    window.otherwiseApp?.showMessage('项目链接已复制到剪贴板', 'success');
                });
            }
        }

        function viewFullDiscussion() {
            // Navigate to discussion page - this would integrate with the existing "否定式对话机制"
            window.location.href = `topic_discussion.html?id=${currentProjectId}`;
        }

        // Handle interest form submission
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('interestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const currentUser = window.otherwiseApp?.currentUser;
                if (!currentUser?.isLoggedIn) return;
                
                const cooperationRole = document.getElementById('cooperationRole').value;
                const cooperationMessage = document.getElementById('cooperationMessage').value;
                
                // Save interest data
                const interestData = {
                    projectId: currentProjectId,
                    userId: currentUser.id,
                    username: currentUser.username,
                    role: cooperationRole,
                    message: cooperationMessage,
                    timestamp: new Date().toISOString()
                };
                
                // Save to user interests
                const userInterests = JSON.parse(localStorage.getItem(`userInterests_${currentUser.id}`) || '[]');
                userInterests.push(currentProjectId);
                localStorage.setItem(`userInterests_${currentUser.id}`, JSON.stringify(userInterests));
                
                // Save interest details
                const projectInterests = JSON.parse(localStorage.getItem(`projectInterests_${currentProjectId}`) || '[]');
                projectInterests.push(interestData);
                localStorage.setItem(`projectInterests_${currentProjectId}`, JSON.stringify(projectInterests));
                
                closeInterestModal();
                window.otherwiseApp?.showMessage('合作兴趣提交成功', 'success');
                
                // Update button state
                const interestButton = document.getElementById('interestButton');
                interestButton.textContent = '已表达兴趣';
                interestButton.disabled = true;
                interestButton.className = 'w-full bg-gray-400 text-white py-3 px-4 rounded-md cursor-not-allowed font-medium';
            });
        });
    </script>
</body>
</html>
